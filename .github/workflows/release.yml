name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(date +'%Y%m%d%H%M%S')"
          fi
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          npm version ${{ steps.version.outputs.clean_version }} --no-git-tag-version --allow-same-version

      - name: Prepare release package
        env:
          PLUGIN_NAME: napcat-plugin-tsai
        run: |
          mkdir -p release
          cp index.mjs release/
          cp package.json release/
          cd release
          zip -r ../${PLUGIN_NAME}.zip index.mjs package.json

      - name: Verify zip contents
        run: |
          PLUGIN_NAME="napcat-plugin-tsai"
          unzip -l ${PLUGIN_NAME}.zip

      - name: Collect git log
        id: gitlog
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          git fetch --tags --force
          PREV_TAG=$(git tag -l "v*" --sort=version:refname | grep -v "$CURRENT_TAG" | tail -1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi
          COMMITS=$(git log --pretty=format:'- %s (%h)' "$PREV_TAG"..HEAD 2>/dev/null || git log --pretty=format:'- %s (%h)' -10)
          echo "$COMMITS" > commits.txt
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Fallback Release Note
        run: |
          CURRENT_TAG="${{ steps.gitlog.outputs.current_tag }}"
          if [ -f ".github/prompt/default.md" ]; then
            sed "s/{VERSION}/$CURRENT_TAG/g" .github/prompt/default.md > CHANGELOG.md
          else
            echo "## $CURRENT_TAG" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### 更新内容" >> CHANGELOG.md
            cat commits.txt >> CHANGELOG.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          files: |
            napcat-plugin-tsai.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger index update
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-index.yml',
              ref: 'main',
              inputs: {
                version: '${{ steps.version.outputs.version }}'
              }
            })
            console.log('✅ 已触发 update-index.yml 工作流')
